{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block app_content %}
<div class="container mt-4">
    <h1>Booklet Scanning - Two Step</h1>
    <div class="row">
        <div class="col-md-8 offset-md-2">

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mt-3">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="card mt-3">
                <div class="card-header">
                    {% if scan_step == 'scan_booklet' and student_info %}
                        Step 2: Scan Booklet for {{ student_info.name }} ({{ student_info.student_id }}) - Exam: {{ student_info.exam_name }}
                    {% else %}
                        Step 1: Find Student & Check Eligibility
                    {% endif %}
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.scan_ui', scan_step=scan_step, student_info=student_info | tojson if student_info else None) }}" id="scanForm">
                        {{ form.hidden_tag() }} {# CSRF token #}

                        {# Always show exam selection, potentially readonly in step 2 #}
                        <div class="form-group row mb-3">
                            <label for="exam_id" class="col-sm-3 col-form-label text-right">Select Exam:</label>
                            <div class="col-sm-9">
                                {% if scan_step == 'scan_booklet' and student_info %}
                                    <input type="text" readonly class="form-control-plaintext" value="{{ student_info.exam_name }}">
                                    {{ form.exam_id(class="form-control d-none", value=student_info.exam_id) }} {# Hidden but submitted #}
                                {% else %}
                                    {{ form.exam_id(class="form-control" + (" is-invalid" if form.exam_id.errors else "")) }}
                                {% endif %}
                                {% if form.exam_id.errors and not (scan_step == 'scan_booklet' and student_info) %}
                                    <div class="invalid-feedback">
                                        {% for error in form.exam_id.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {# Student Identifier Field - visible in step 1, readonly/hidden in step 2 #}
                        <div class="form-group row mb-3">
                            <label for="student_identifier" class="col-sm-3 col-form-label text-right">Student ID:</label>
                            <div class="col-sm-9">
                                {% if scan_step == 'scan_booklet' and student_info %}
                                    <input type="text" readonly class="form-control-plaintext" value="{{ student_info.student_id }}">
                                    {{ form.student_identifier(class="form-control d-none", value=student_info.student_id) }} {# Hidden but submitted #}
                                {% else %}
                                    {{ form.student_identifier(class="form-control" + (" is-invalid" if form.student_identifier.errors else ""), autofocus=true, placeholder="Scan or type Student ID") }}
                                {% endif %}
                                {% if form.student_identifier.errors and not (scan_step == 'scan_booklet' and student_info) %}
                                    <div class="invalid-feedback">
                                        {% for error in form.student_identifier.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {# Booklet Code Field - visible only in step 2 #}
                        {% if scan_step == 'scan_booklet' and student_info %}
                            <div class="form-group row mb-3">
                                <label for="booklet_code" class="col-sm-3 col-form-label text-right">Booklet Code:</label>
                                <div class="col-sm-9">
                                    {{ form.booklet_code(class="form-control" + (" is-invalid" if form.booklet_code.errors else ""), autofocus=true, placeholder="Scan or type Booklet Code") }}
                                    {% if form.booklet_code.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.booklet_code.errors %}<span>{{ error }}</span>{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}

                        {# Submit Buttons - visibility depends on step #}
                        <div class="form-group row">
                            <div class="col-sm-9 offset-sm-3">
                                {% if scan_step == 'scan_booklet' and student_info %}
                                    {{ form.submit_record_scan(class="btn btn-success btn-block shadow-sm") }}
                                    <a href="{{ url_for('main.scan_ui') }}" class="btn btn-outline-secondary btn-block mt-2">Cancel / Next Student</a>
                                {% else %}
                                    {% if form.exam_id.choices %}
                                        {{ form.submit_check_student(class="btn btn-primary btn-block shadow-sm") }}
                                    {% else %}
                                        <p class="text-center text-muted">No exams available for scanning. Please add exams in the admin panel.</p>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mt-3">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            {% if scan_step == 'scan_booklet' and student_info %}
                 {# Display last scan details if available, only in booklet scan step if a booklet was just processed #}
                {% if last_scan_data %}
                <div id="last_scan_info" class="mt-4 p-3 border rounded bg-light shadow-sm">
                    <h4 class="text-success">Last Successful Scan:</h4>
                    <p><strong>Student:</strong> {{ last_scan_data.student_name }} ({{ last_scan_data.student_id }})</p>
                    <p><strong>Exam:</strong> {{ last_scan_data.exam_name }}</p>
                    <p><strong>Booklet Code:</strong> {{ last_scan_data.booklet_code }}</p>
                    <p><strong>Time:</strong> <span id="last_scan_time_rendered"></span></p>
                    <script>
                        document.getElementById('last_scan_time_rendered').textContent = new Date("{{ last_scan_data.timestamp }}").toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    </script>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const scanStep = "{{ scan_step }}";
    const studentIdentifierInput = document.getElementById('student_identifier');
    const bookletCodeInput = document.getElementById('booklet_code');
    const examIdInput = document.getElementById('exam_id'); // Assuming this is the ID of the select element

    if (scanStep === 'check_student') {
        if (studentIdentifierInput) {
            studentIdentifierInput.focus();
        } else if (examIdInput) { // If student ID field isn't there (e.g. no exams)
            examIdInput.focus();
        }
    } else if (scanStep === 'scan_booklet') {
        if (bookletCodeInput) {
            bookletCodeInput.focus();
            bookletCodeInput.value = ''; // Ensure booklet field is clear for new scan
        }
    }

    // Autofocus logic for student_identifier or booklet_code based on scan_step
    // The autofocus HTML attribute on the relevant field should handle the initial focus.
    // This script can handle focus after form submissions/re-renders if needed.

    // Clear relevant fields for next input based on step, especially after successful operations
    // This is now largely handled by redirects to specific states or by the route logic clearing form data.
    // Example: after successful booklet scan, route redirects to 'check_student', effectively clearing for next student.
    // After successful student check, route re-renders with booklet_code empty and focused.

    // If student_info is available (meaning student was verified), perhaps make student_identifier readonly
    {% if student_info and scan_step == 'scan_booklet' %}
        if (studentIdentifierInput && !studentIdentifierInput.classList.contains('d-none')) { // Check if it's the visible input
            // studentIdentifierInput.readOnly = true; // This was done by making it form-control-plaintext
        }
        if (examIdInput && !examIdInput.classList.contains('d-none')) {
            // examIdInput.disabled = true; // This was done by making it form-control-plaintext
        }
    {% endif %}
});
</script>
{% endblock %}
