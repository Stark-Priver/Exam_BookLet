{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block app_content %}
<div class="container mt-4">
    <h1>Booklet Scanning</h1>
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    Scan Booklet
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.scan_ui') }}" id="scanForm">
                        {{ form.hidden_tag() }} {# CSRF token #}

                        <div class="form-group row mb-3">
                            <label for="exam_id" class="col-sm-3 col-form-label text-right">Select Exam:</label>
                            <div class="col-sm-9">
                                {{ form.exam_id(class="form-control" + (" is-invalid" if form.exam_id.errors else "")) }}
                                {% if form.exam_id.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.exam_id.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group row mb-3">
                            <label for="booklet_code" class="col-sm-3 col-form-label text-right">Booklet Code:</label>
                            <div class="col-sm-9">
                                {{ form.booklet_code(class="form-control" + (" is-invalid" if form.booklet_code.errors else ""), autofocus=true, placeholder="Scan or type booklet code") }}
                                {% if form.booklet_code.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.booklet_code.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {# This field will be populated by JavaScript after a successful scan or if a student needs to be manually entered/confirmed #}
                        <div class="form-group row mb-3">
                            <label for="student_identifier" class="col-sm-3 col-form-label text-right">Student ID:</label>
                            <div class="col-sm-9">
                                {{ form.student_identifier(class="form-control" + (" is-invalid" if form.student_identifier.errors else ""), placeholder="Student ID (e.g., from booklet or manual entry)") }}
                                {% if form.student_identifier.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.student_identifier.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-sm-9 offset-sm-3">
                                {{ form.submit(class="btn btn-primary btn-block") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mt-3">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <div id="last_scan_info" class="mt-4 p-3 border rounded" style="display: none;">
                <h4>Last Scan Details:</h4>
                <p><strong>Student:</strong> <span id="last_student_name"></span> (<span id="last_student_id"></span>)</p>
                <p><strong>Exam:</strong> <span id="last_exam_name"></span></p>
                <p><strong>Booklet Code:</strong> <span id="last_booklet_code"></span></p>
                <p><strong>Time:</strong> <span id="last_scan_time"></span></p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const bookletCodeInput = document.getElementById('booklet_code');
    const studentIdentifierInput = document.getElementById('student_identifier');
    const examIdInput = document.getElementById('exam_id');
    const scanForm = document.getElementById('scanForm');

    // Focus on booklet code input on page load
    if(bookletCodeInput) {
        bookletCodeInput.focus();
    }

    // Optional: Automatically submit form if booklet code looks complete (e.g., after USB scan)
    // This might need adjustment based on typical scanner behavior (e.g., if it sends an "Enter" key press)
    // bookletCodeInput.addEventListener('input', function() {
    //     // Example: if booklet code is 10 characters long and scanner doesn't send 'Enter'
    //     if (this.value.length === 10 && studentIdentifierInput.value.length > 0 && examIdInput.value !== "") {
    //         // scanForm.submit();
    //         // Be cautious with auto-submit, might not always be desired.
    //     }
    // });

    // Clear booklet and student ID fields after form submission if it wasn't an error,
    // so the scanner is ready for the next input.
    // This would typically be handled by the server redirecting or re-rendering the form,
    // but if using AJAX or for better UX on re-render:
    {% if not form.errors and get_flashed_messages(category_filter=["success"]) %}
        if(bookletCodeInput) bookletCodeInput.value = '';
        if(studentIdentifierInput) studentIdentifierInput.value = '';
        // Preserve exam selection
        // if(examIdInput) examIdInput.value = '{{ form.exam_id.data }}'; // This line might be tricky due to Jinja vs JS timing
        if(bookletCodeInput) bookletCodeInput.focus();
    {% elif form.booklet_code.data and not form.booklet_code.errors and not (form.student_identifier.errors or form.exam_id.errors) %}
        // If there was a booklet code submitted and it didn't have an error,
        // and other fields also don't have errors (implying a successful submission flow, even if a flash warning occurred for other reasons)
        // clear it for next scan.
        if(bookletCodeInput) bookletCodeInput.value = '';
        if(studentIdentifierInput) studentIdentifierInput.value = ''; // Also clear student ID
        if(bookletCodeInput) bookletCodeInput.focus();
    {% else %}
        // If there were errors, keep focus on the first field with an error
        if (form.exam_id.errors && examIdInput) examIdInput.focus();
        else if (form.booklet_code.errors && bookletCodeInput) bookletCodeInput.focus();
        else if (form.student_identifier.errors && studentIdentifierInput) studentIdentifierInput.focus();
        else if (bookletCodeInput) bookletCodeInput.focus(); // Default focus
    {% endif %}


    // If last_scan_data is passed from the server, display it
    {% if last_scan_data %}
    const scanData = JSON.parse('{{ last_scan_data | tojson | safe }}');
    if (scanData) {
        showLastScan(scanData);
    }
    {% endif %}

});

function showLastScan(data) {
    document.getElementById('last_student_name').textContent = data.student_name;
    document.getElementById('last_student_id').textContent = data.student_id;
    document.getElementById('last_exam_name').textContent = data.exam_name;
    document.getElementById('last_booklet_code').textContent = data.booklet_code;
    document.getElementById('last_scan_time').textContent = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('last_scan_info').style.display = 'block';
}
</script>
{% endblock %}
